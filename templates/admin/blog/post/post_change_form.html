{% extends "admin/change_form.html" %}

{% load static %}

{% block extrahead %}
    {{ block.super }}
    <!-- 引入FontAwesome提供附件图标 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        /* 隐藏多余的label */
        label[for="id_content"] {
            display: none !important;
        }

        .editormd-dialog {
            height: 260px !important; /* 自定义固定高度，!important 覆盖内联样式 */
            overflow-y: auto; /* 内容超出时出现滚动条，避免溢出 */
        }

        /* 1. 基础弹窗容器样式（高优先级选择器） */
        .editormd-dialog.editormd-image-dialog {
            width: 600px !important;
            padding: 20px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
            background-color: #fff !important;
        }

        .editormd-form .fa-btns a {
            padding: 0 !important; /* 强制移除内边距 */
            margin: 0 !important; /* 可选：同时移除外边距 */
            line-height: 1 !important; /* 修正行高影响 */
        }

        /* 若存在图标，单独调整图标内边距 */
        .editormd-form .fa-btns a i {
            padding: 0 !important;
        }

    </style>

    <script>
        // 1. 为了防止跨站请求伪造（CSRF）攻击，会要求所有非 GET 请求（如 POST、PUT、DELETE 等）必须携带一个有效的 CSRF Token。
        // 这个 Token 通常存储在名为 csrftoken 的 Cookie 中
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
function createAttachmentButton(toolbar) {
    // 【关键修改】找“添加图片”的 <li>（通过 title 或 class 精准定位）
   const editorMenuUl = document.querySelector('ul.editormd-menu');
    if (editorMenuUl) {
        // 创建附件按钮的 <li>
        const attachmentLi = document.createElement('li');
        attachmentLi.className = 'wmd-button custom-md-button attachment-btn';
        attachmentLi.title = '上传附件';
        
       const attachmentA = document.createElement('a');
        const icon = document.createElement('i');
        icon.className = 'fa fa-paperclip '; 
        attachmentA.appendChild(icon);
        attachmentLi.appendChild(attachmentA);


          // 绑定点击事件（上传附件）
         attachmentA.addEventListener('click', function(event) {
            event.stopPropagation(); // 阻止事件冒泡
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.txt'; // 允许的文件类型
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
    
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
    
                // 发送文件到后端（需配合后端接口）
                const formData = new FormData();
                formData.append('file', file);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '{% url "upload_attachment" %}', true);
                xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    if (res.success) {
                        // 插入附件链接到编辑器
                       const attachmentLink = `[📎 ${res.name}](${res.url})\n\n`;

                        insertToEditor(attachmentLink);
                        alert('上传成功');
                    } else {
                        alert('上传失败：' + res.message);
                    }
                }
                document.body.removeChild(fileInput);
            };
            xhr.send(formData);
        };
        fileInput.click();
    });

        // 插入到“添加图片”<ul> 的后面
        editorMenuUl.appendChild(attachmentLi);
    }
}


// 3. 工具函数：向编辑器插入内容（超级增强版，覆盖更多场景）
function insertToEditor(text) {
    console.log('=== 开始插入内容 ===');
    console.log('待插入内容:', text);
    console.log('文本长度:', text.length);

    // 辅助函数：通用插入逻辑（适用于textarea类元素）
    insertIntoCodeMirrorAtEnd(text);
    
    return true;
}


function getCodeMirrorInstance() {
    // 方法1：通过编辑器容器 ID 查找（推荐，精准）
    const editorElement = document.getElementById('id_content'); // 替换为你的编辑器容器 ID
    if (editorElement && editorElement.CodeMirror) {
        return editorElement.CodeMirror;
    }

    // 方法2：遍历所有实例（当无法确定 ID 时使用）
    if (window.CodeMirror && window.CodeMirror.instances) {
        // 取第一个实例（如果页面只有一个编辑器）
        return window.CodeMirror.instances[0];
    }

    // 方法3：通过 CodeMirror 内部存储查找
    const cmInstances = document.querySelectorAll('.CodeMirror');
    if (cmInstances.length > 0) {
        return cmInstances[0].CodeMirror;
    }

    console.error('未找到 CodeMirror 实例');
    return null;
}


document.addEventListener('DOMContentLoaded', function() {
    let checkCount = 0;
    const maxChecks = 30; // 最多检查30次（15秒）
    const interval = setInterval(function() {
        checkCount++;

        // 查找工具栏
        let toolbar = document.querySelector('.editormd-toolbar');

        // 如果找到工具栏，添加自定义按钮
        if (toolbar) {
            console.log('找到编辑器工具栏，添加自定义按钮');
            createAttachmentButton(toolbar); // 添加附件按钮
            clearInterval(interval);
            return;
        }

        // 超过最大次数，提示错误
        if (checkCount >= maxChecks) {
            clearInterval(interval);
            console.error('未找到编辑器工具栏，请检查配置');
        }
    }, 50);
});
    
    
  // 向 CodeMirror 插入内容（在文件末尾）
function insertIntoCodeMirrorAtEnd(text) {
    const cm = getCodeMirrorInstance();
    if (!cm) return false;

    try {
        // 获取最后一行的行号（CodeMirror 行号从 0 开始）
        const lastLine = cm.lineCount() - 1;
        // 获取最后一行的内容长度（确定光标在最后一行的位置）
        const lastLineLength = cm.getLine(lastLine).length;

        // 定位光标到最后一行的末尾
        const endCursor = {
            line: lastLine,
            ch: lastLineLength
        };

        // 在末尾插入内容（如果文件非空，先加一个换行）
        const contentToInsert = lastLineLength > 0 ? `\n${text}` : text;
        cm.replaceRange(contentToInsert, endCursor);

        // 移动光标到插入内容的末尾
        cm.setCursor({
            line: lastLine + (lastLineLength > 0 ? 1 : 0), // 若新增了换行，行号+1
            ch: lastLineLength > 0 ? text.length : lastLineLength + text.length
        });

        // 确保编辑器获得焦点
        cm.focus();
        console.log('内容已插入到 CodeMirror 末尾');
        return true;
    } catch (e) {
        console.error('插入到 CodeMirror 末尾失败:', e);
        return false;
    }
}

    </script>
{% endblock %}
{% extends "admin/change_form.html" %}

{% load static %}

{% block extrahead %}
    {{ block.super }}
    <!-- å¼•å…¥FontAwesomeæä¾›é™„ä»¶å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        /* éšè—å¤šä½™çš„label */
        label[for="id_content"] {
            display: none !important;
        }

        .editormd-dialog {
            height: 260px !important; /* è‡ªå®šä¹‰å›ºå®šé«˜åº¦ï¼Œ!important è¦†ç›–å†…è”æ ·å¼ */
            overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶å‡ºç°æ»šåŠ¨æ¡ï¼Œé¿å…æº¢å‡º */
        }

        /* 1. åŸºç¡€å¼¹çª—å®¹å™¨æ ·å¼ï¼ˆé«˜ä¼˜å…ˆçº§é€‰æ‹©å™¨ï¼‰ */
        .editormd-dialog.editormd-image-dialog {
            width: 600px !important;
            padding: 20px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
            background-color: #fff !important;
        }

        .editormd-form .fa-btns a {
            padding: 0 !important; /* å¼ºåˆ¶ç§»é™¤å†…è¾¹è· */
            margin: 0 !important; /* å¯é€‰ï¼šåŒæ—¶ç§»é™¤å¤–è¾¹è· */
            line-height: 1 !important; /* ä¿®æ­£è¡Œé«˜å½±å“ */
        }

        /* è‹¥å­˜åœ¨å›¾æ ‡ï¼Œå•ç‹¬è°ƒæ•´å›¾æ ‡å†…è¾¹è· */
        .editormd-form .fa-btns a i {
            padding: 0 !important;
        }

    </style>

    <script>
        // 1. ä¸ºäº†é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰æ”»å‡»ï¼Œä¼šè¦æ±‚æ‰€æœ‰é GET è¯·æ±‚ï¼ˆå¦‚ POSTã€PUTã€DELETE ç­‰ï¼‰å¿…é¡»æºå¸¦ä¸€ä¸ªæœ‰æ•ˆçš„ CSRF Tokenã€‚
        // è¿™ä¸ª Token é€šå¸¸å­˜å‚¨åœ¨åä¸º csrftoken çš„ Cookie ä¸­
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
function createAttachmentButton(toolbar) {
    // ã€å…³é”®ä¿®æ”¹ã€‘æ‰¾â€œæ·»åŠ å›¾ç‰‡â€çš„ <li>ï¼ˆé€šè¿‡ title æˆ– class ç²¾å‡†å®šä½ï¼‰
   const editorMenuUl = document.querySelector('ul.editormd-menu');
    if (editorMenuUl) {
        // åˆ›å»ºé™„ä»¶æŒ‰é’®çš„ <li>
        const attachmentLi = document.createElement('li');
        attachmentLi.className = 'wmd-button custom-md-button attachment-btn';
        attachmentLi.title = 'ä¸Šä¼ é™„ä»¶';
        
       const attachmentA = document.createElement('a');
        const icon = document.createElement('i');
        icon.className = 'fa fa-paperclip '; 
        attachmentA.appendChild(icon);
        attachmentLi.appendChild(attachmentA);


          // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä¸Šä¼ é™„ä»¶ï¼‰
         attachmentA.addEventListener('click', function(event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.txt'; // å…è®¸çš„æ–‡ä»¶ç±»å‹
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
    
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
    
                // å‘é€æ–‡ä»¶åˆ°åç«¯ï¼ˆéœ€é…åˆåç«¯æ¥å£ï¼‰
                const formData = new FormData();
                formData.append('file', file);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '{% url "upload_attachment" %}', true);
                xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    if (res.success) {
                        // æ’å…¥é™„ä»¶é“¾æ¥åˆ°ç¼–è¾‘å™¨
                       const attachmentLink = `[ğŸ“ ${res.name}](${res.url})\n\n`;

                        insertToEditor(attachmentLink);
                        alert('ä¸Šä¼ æˆåŠŸ');
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥ï¼š' + res.message);
                    }
                }
                document.body.removeChild(fileInput);
            };
            xhr.send(formData);
        };
        fileInput.click();
    });

        // æ’å…¥åˆ°â€œæ·»åŠ å›¾ç‰‡â€<ul> çš„åé¢
        editorMenuUl.appendChild(attachmentLi);
    }
}


// 3. å·¥å…·å‡½æ•°ï¼šå‘ç¼–è¾‘å™¨æ’å…¥å†…å®¹ï¼ˆè¶…çº§å¢å¼ºç‰ˆï¼Œè¦†ç›–æ›´å¤šåœºæ™¯ï¼‰
function insertToEditor(text) {
    console.log('=== å¼€å§‹æ’å…¥å†…å®¹ ===');
    console.log('å¾…æ’å…¥å†…å®¹:', text);
    console.log('æ–‡æœ¬é•¿åº¦:', text.length);

    // è¾…åŠ©å‡½æ•°ï¼šé€šç”¨æ’å…¥é€»è¾‘ï¼ˆé€‚ç”¨äºtextareaç±»å…ƒç´ ï¼‰
    insertIntoCodeMirrorAtEnd(text);
    
    return true;
}


function getCodeMirrorInstance() {
    // æ–¹æ³•1ï¼šé€šè¿‡ç¼–è¾‘å™¨å®¹å™¨ ID æŸ¥æ‰¾ï¼ˆæ¨èï¼Œç²¾å‡†ï¼‰
    const editorElement = document.getElementById('id_content'); // æ›¿æ¢ä¸ºä½ çš„ç¼–è¾‘å™¨å®¹å™¨ ID
    if (editorElement && editorElement.CodeMirror) {
        return editorElement.CodeMirror;
    }

    // æ–¹æ³•2ï¼šéå†æ‰€æœ‰å®ä¾‹ï¼ˆå½“æ— æ³•ç¡®å®š ID æ—¶ä½¿ç”¨ï¼‰
    if (window.CodeMirror && window.CodeMirror.instances) {
        // å–ç¬¬ä¸€ä¸ªå®ä¾‹ï¼ˆå¦‚æœé¡µé¢åªæœ‰ä¸€ä¸ªç¼–è¾‘å™¨ï¼‰
        return window.CodeMirror.instances[0];
    }

    // æ–¹æ³•3ï¼šé€šè¿‡ CodeMirror å†…éƒ¨å­˜å‚¨æŸ¥æ‰¾
    const cmInstances = document.querySelectorAll('.CodeMirror');
    if (cmInstances.length > 0) {
        return cmInstances[0].CodeMirror;
    }

    console.error('æœªæ‰¾åˆ° CodeMirror å®ä¾‹');
    return null;
}


document.addEventListener('DOMContentLoaded', function() {
    let checkCount = 0;
    const maxChecks = 30; // æœ€å¤šæ£€æŸ¥30æ¬¡ï¼ˆ15ç§’ï¼‰
    const interval = setInterval(function() {
        checkCount++;

        // æŸ¥æ‰¾å·¥å…·æ 
        let toolbar = document.querySelector('.editormd-toolbar');

        // å¦‚æœæ‰¾åˆ°å·¥å…·æ ï¼Œæ·»åŠ è‡ªå®šä¹‰æŒ‰é’®
        if (toolbar) {
            console.log('æ‰¾åˆ°ç¼–è¾‘å™¨å·¥å…·æ ï¼Œæ·»åŠ è‡ªå®šä¹‰æŒ‰é’®');
            createAttachmentButton(toolbar); // æ·»åŠ é™„ä»¶æŒ‰é’®
            clearInterval(interval);
            return;
        }

        // è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œæç¤ºé”™è¯¯
        if (checkCount >= maxChecks) {
            clearInterval(interval);
            console.error('æœªæ‰¾åˆ°ç¼–è¾‘å™¨å·¥å…·æ ï¼Œè¯·æ£€æŸ¥é…ç½®');
        }
    }, 50);
});
    
    
  // å‘ CodeMirror æ’å…¥å†…å®¹ï¼ˆåœ¨æ–‡ä»¶æœ«å°¾ï¼‰
function insertIntoCodeMirrorAtEnd(text) {
    const cm = getCodeMirrorInstance();
    if (!cm) return false;

    try {
        // è·å–æœ€åä¸€è¡Œçš„è¡Œå·ï¼ˆCodeMirror è¡Œå·ä» 0 å¼€å§‹ï¼‰
        const lastLine = cm.lineCount() - 1;
        // è·å–æœ€åä¸€è¡Œçš„å†…å®¹é•¿åº¦ï¼ˆç¡®å®šå…‰æ ‡åœ¨æœ€åä¸€è¡Œçš„ä½ç½®ï¼‰
        const lastLineLength = cm.getLine(lastLine).length;

        // å®šä½å…‰æ ‡åˆ°æœ€åä¸€è¡Œçš„æœ«å°¾
        const endCursor = {
            line: lastLine,
            ch: lastLineLength
        };

        // åœ¨æœ«å°¾æ’å…¥å†…å®¹ï¼ˆå¦‚æœæ–‡ä»¶éç©ºï¼Œå…ˆåŠ ä¸€ä¸ªæ¢è¡Œï¼‰
        const contentToInsert = lastLineLength > 0 ? `\n${text}` : text;
        cm.replaceRange(contentToInsert, endCursor);

        // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹çš„æœ«å°¾
        cm.setCursor({
            line: lastLine + (lastLineLength > 0 ? 1 : 0), // è‹¥æ–°å¢äº†æ¢è¡Œï¼Œè¡Œå·+1
            ch: lastLineLength > 0 ? text.length : lastLineLength + text.length
        });

        // ç¡®ä¿ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
        cm.focus();
        console.log('å†…å®¹å·²æ’å…¥åˆ° CodeMirror æœ«å°¾');
        return true;
    } catch (e) {
        console.error('æ’å…¥åˆ° CodeMirror æœ«å°¾å¤±è´¥:', e);
        return false;
    }
}

    </script>
{% endblock %}